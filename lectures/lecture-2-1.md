## Управление памятью

В реальном режиме машин x86 архитектуры операторы памяти определены
следующим образом:


 Номер | Адрес | Видеопамять
:---:|---|---
1|0h    | Векторы прерываний
2|40h   | Нижняя память (Low memory) 640 к
3|A000h | Видеопамять
4|      | Верхняя память Upper memory
 |      | ...
5|      | Расширение BIOS
 |      | ...
6| FFFh | ROM BIOS




__(1)__ - Адреса обработчиков прерываний

__(1,2)__ - Conventional Memory

__(3)__ - Физически в видеоадаптере (хранит образ экрана)

__(6)__ - Read Only Memory. Программы запускаемые сразу после
включения питания

__(4)__ - До 1 Мб _UMB_, _XMS_, _EMS_

__(4,5)__ - High Memory Area

После загрузки DOS Conventional memory выглядит следующим образом:

| Conventional memory |
| --- |
| Вектор прерываний |
| Данный DOS,  BIOS|
| Ядро DOS |
| CMB |
| Резедентная часть Command.com |
| CMB |
| Окружение |
| CMB |
| Резедентная программа 2 |
| CMB |
| Свободная часть |
| Нерезедентная часть Command.com |


CMB (Control Memory Block) - блок контроля за памятью.

- Занимает 256 байт (страницу)
- Содержит данные о состоянии блока памяти, котоый за ним следует

__Поля:__

1. PSP - адрес владельца блока
2. Размер блока (в параграфах)
3. Признак конечного блока

__Опр.__ PSP (Program Segment Prefix) - префикс сегмента программы.
Атрибут блоков в которых могут распологаться программы. Формат блкоа памяти, который
содержит программу.

CMB | PSP | Сегмент стека | Сегмент данных | Сегмент кода программы
---|---|---|---|---

Программе блок ожидается целиком. Может произойти нехватка памяти.
Программа должна освобождать неиспользуемую память.

В DOS есть специальные функции:
- 48h - выделить память
- 49h - освободить память
- 4Ah - переопределить размер блока

```
DOS 48h (выделение памяти):
  Вход:
  AH = 48h
  BX = Размер блока в парах (16 байт)

  Выход:
  CF = 0 - все хорощо
  CF = 1 - ошибка, в AX код ошибки
  AX = 7 - CMB разрешен
  AX = 8 - не хватило памяти
  BX = размер макс. доступного блока
```

```
DOS 49h (освобождение памяти):
  Вход:
  AH = 49h
  ES = сегментный адрес блока, кот. нужно освободить

  Выход:
  CF = 0 - все хорощо
  CF = 1 - ошибка, в AX код ошибки
  AX = 7 - CMB разрушен (нету)
  AX = 9 - в ES записан неверный адрес
```

```
DOS 50h (претвориться владельцем блока):
  Вход:
  AH = 50h
  BX = сегмент адреса PSP
```

```
DOS 4Ah (изменить размер блока):
  Вход:
  AH = 4Ah
  BX = Желаемый размер в параграфах
  ES = Сегментный адрес, которого меняем

  Выход:
  CF = 0 - все хорощо
  CF = 1 - ошибка, в AX код ошибки
  AX = 7 - CMB разрушен (нету)
  AX = 8 - слишком много памяти (BX = размер макс. доступной памяти)
  AX = 9 - в ES записан неверный адрес
```

```
DOS 58h (изменить стратегию выбора памяти):
  Вход:
  AH = 58h

  2-0 биты
  00 - первый подходящий
  01 - наиб. подходящий
  11 - послед. подходящий

  4-3 биты
  00 - в раб. памяти
  01 - UMB-память (DOS 5.0+)
  11 - UMB + раб. память (DOS 5.0+)
```

UMB - 640кб - 1Мб. (управление через функции 21h)


#### High memory area
_High memory area - 655205 байт памяти._

__Опр.__ Интерфейс EMS (Expanded Memory) - доступ
к памяти осуществляется, через «окно» (4 страницы по 16кб - всего 64кб).

0 - 16кб|1 - 16кб
---|---
2 - 16кб|3 - 16кб

__Порядок работы с EMS:__


1. Запретить EMS память и получить ID. (0-12 - кол-во 16кб страниц)
2. Отобразить страницы на окно. Назначить 4 (или меньше) рабочие страницы из запрошенных выше.
3. Получить адрес «окна». BX - сегментный адрес окна.

  ```
    push   bx
    pop    ds
    mov    ds:[di], bx ; пишет в окно
  ```

_(работа происходит через 67h прерывание)_

__Опр.__ XMS (Extended Memory) - используется пересылка данных

__Порядок работы:__

1. Проверить наличие XMS;
2. Получить адрес функции обработчика (__dword ptr FunсXMS__);
3. С помощью фукнции 09h работы с памятью формируем структуру данных:
	- Откуда передать данные
	- Сколько переслать
	- Куда переслать
	
__(!)__ _использовать DosBOX (можно DosPET) для разработки_