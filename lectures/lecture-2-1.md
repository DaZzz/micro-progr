## Управление памятью

В реальном режиме машин x86 архитектуры операторы памяти определены
следующим образом


 Номер | Адрес | Видеопамять
:---:|---|------------------------------
1|0h    | Векторы прерываний
2|40h   | Нижняя память (Low memory)
3|A000h |  Видеопамять
4|      |  Верхняя память Upper memory
 |      |  ...
5|      |  Расширение BIOS
 |      |  ...
6| FFFh |  ROM BIOS




__(1)__ - Адреса обработчиков прерываний

__(1,2)__ - Conventional Memory

__(3)__ - Физически в видеоадаптере (хранит образ экрана)

__(6)__ - Read Only Memory. Программы запускаемые сразу после
включения питания

__(4)__ - До 1 Мб _UMB_, _XMS_, _EMS_

__(4,5)__ - High Memory Area

| Conventional memory |
| --- |
| Вектор прерываний |
| Данный DOS,  BIOS|
| Ядро DOS |
| CMB |
| Резедентная часть Command.com |
| CMB |
| Окружение |
| CMB |
| Резедентная программа 2 |
| CMB |
| Свободная часть |
| Нерезедентная часть Command.com |


CMB (Control Memory Block) - блок управления (признаки состояния, etc.)

- Занимает 256 байт (страницу)
- Содержит данные о состоянии блока памяти, котоый за ним следует

__Поля:__

1. PSP - адрес владельца блока
2. Размер блока (в параграфах)
3. Признак конечного блока

__Опр.__ PSP (Program Segment Prefix) - префикс сегмента программы.
Атрибут блоков в которых могут распологаться программы. Формат блкоа памяти, который
содержит программу.

CMB | PSP | Сегмент стека | Сегмент данных | Сегмент кода программы
---|---|---|---|---

Программе блок ожидается целиком. Может произойти нехватка памяти.
Программа должна освобождать неиспользуемую память.

В DOS есть специальные функции:
- 48h - выделить память
- 49h - освободить память
- 4Ah - переопределить размер блока

```
DOS 48h (выделение памяти):
  Вход:
  AH = 48h
  BX = Размер блока в парах (16 байт)

  Выход:
  CF = 0 - все хорощо
  cf = 1 - ошибка, в AX код ошибки
  AX = 7 - CMB разрешен
  AX = 8 - не хватило памяти
  BX = размер макс. доступного блока
```

```
DOS 49h (освобождение памяти):
  Вход:
  AH = 48h
  ES = сегментный адрес блока, кот. нужно освободить

  Выход:
  CF = 0 - все хорощо
  CF = 1 - ошибка, в AX код ошибки
  AX = 7 - CMB разрушен (нету)
  AX = 9 - в ES записан неверный адрес
```